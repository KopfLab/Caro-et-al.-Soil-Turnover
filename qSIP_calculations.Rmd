---
title: "2H qSIP Calculations"
author: "Tristan Caro"
date: "`r Sys.Date()`"
output:
    html_document:
    code_folding: show
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
# global knitting options for code rendering
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")

# global knitting options for automatic saving of all plots as .png and .pdf
knitr::opts_chunk$set(
  dev = c("png", "pdf"),
  dev.args = list(pdf = list(encoding = "WinAnsi", useDingbats = FALSE)),
  fig.keep = "all",
  fig.path = file.path("fig_output", paste0(gsub("\\.[Rr]md", "", knitr::current_input()), "_"))
)
```

# Load packages

```{r, message=FALSE, warning=FALSE}
library(tidyverse) # general data wrangling and plotting
library(isoreader) # reading the raw data files
library(isoprocessor) # processing the data
library(isotopia) # isotope utilities
library(readxl) # reading excel docs
library(ggsci) # some nice color palettes
library(ggborderline) # nice looking ggplot lines
library(ggrepel)
library(latex2exp)
library(ggdist)

source(file.path("libs", "visualization.R"))
source(file.path("libs", "chromleon.R"))
`%nin%` = Negate(`%in%`)
```

This analysis was run using [isoreader](http://isoreader.kopflab.org) version `r packageVersion("isoreader")` and [isoprocessor](http://isoprocessor.kopflab.org/) version `r packageVersion("isoprocessor")`. 

# Load data

## Read raw data files

```{r, warning=FALSE}
# set file path(s) to data files, folders or rds collections 
# can be multiple folders or mix of folders and files
# setting the month of analysis folder - Isoverse will iteratively search subfolders. Huzzah! ^_^
data_path <- file.path("data", "IRMS", "2021-09")
ref_ratio <- get_standard("2H") %>% as.numeric()

# read files
iso_files_raw <- 
  # path to data files
  data_path %>% 
  # read data files in parallel for fast read
  iso_read_continuous_flow() %>%
  # filter out files with read errors (e.g. from aborted analysis)
  iso_filter_files_with_problems()
```

## Process file info & peak table

```{r}
# process file information
iso_files <- iso_files_raw %>% 
  # rename key file info columns
  iso_rename_file_info(analysis = Analysis, id1 = `Identifier 1`, id2 = `Identifier 2`) %>% 
  # parse text info into numbers
  iso_parse_file_info(number = analysis) %>% 
  # process other file information that is specific to the naming conventions
  # of this particular sequence
  iso_mutate_file_info(
    # what is the type of each analysis?
    type = case_when(
      str_detect(id1, "[Zz]ero")      ~ "on_off",
      str_detect(id1, "H3")           ~ "H3_factor",
      str_detect(id1, "F8")           ~ "F8_std",
      str_detect(id1, "F9")           ~ "F9_std",
      TRUE                            ~ "sample"
    ),
    # what was the concentration? (assuming Preparation = concentration or volume)
    concentration = 
      ifelse(type == "std",  
             str_extract(Preparation, "[0-9.]+ ?ng( per |/)uL") %>% 
               parse_number() %>% iso_double_with_units("ng/uL"),
             NA),
    # what folder are the data files in? (assuming folder = sequence)
    folder = basename(dirname(file_path))
  ) %>% 
  # focus only on the relevant file info, discarding the rest
  iso_select_file_info(
    folder, analysis, file_datetime, id1, type, concentration
  ) %>% 
  # add in additional sample metadata (could be any info)
  # note: this would typically be stored in / read from a csv or excel file
  iso_add_file_info(
    read_csv(file.path("data", "sample_metadata_2021.csv")),
    join_by = "id1"
  )

# set peak table from vendor data table with default isodat template
iso_files <- iso_set_peak_table_from_isodat_vendor_data_table(iso_files) %>% 
  # convert units from mV to V for amplitudes and area
  iso_convert_peak_table_units(V = mV, Vs = mVs)

# focus on sample files
sample_files <- iso_filter_files(iso_files, type == "sample")

# EXCLUDE CRC SAMPLES FROM THIS ANALYSIS
sample_files <- iso_filter_files(sample_files, str_detect(id1, "cri", negate = TRUE))

sample_files <- iso_filter_files(sample_files, str_detect(id1, "cr0", negate = TRUE))

# EXCLUDE C26 ALKANE STANDARD
sample_files <- iso_filter_files(sample_files, str_detect(id1, "C26", negate = TRUE))
```

## Show file information

```{r}
# display file information
iso_files %>% 
  iso_get_file_info() %>% select(-file_id, -folder) %>% 
  iso_make_units_explicit() %>% knitr::kable()
```

## Example chromatograms

```{r "example_chromatograms", fig.width=8, fig.height=8}
# plot an example chromatogram

sample_files[10] %>% # choosing arbitrary file to plot
iso_plot_continuous_flow_data(
  # select data and aesthetics
  data = c(2), color = id1, panel = id1,
  # zoom in on time interval
  time_interval = c(750, 4000),
  # peak labels for all peaks > 2V
  peak_bounds = TRUE,
  peak_marker = FALSE,
  peak_label = iso_format(rt),
  #peak_label_size = 3,
  peak_label_filter = analysis == 5685 & amp2 > 1
) + scale_color_npg() + 
  theme_classic() +
  theme(strip.background = element_blank())
```

# Peak Mapping

```{r}
# this information is often maintained in a csv or Excel file
peak_map <- 
  readxl::read_excel(file.path("data","IRMS", "peak_map_manual_general.xlsx"))
peak_map

peak_table <- sample_files %>%
  iso_set_peak_table_from_isodat_vendor_data_table() %>%
  iso_get_peak_table() %>% 
  mutate(Analysis = substr(file_id, 1, 7),
         sample_id = substr(file_id, 10,14))
```

```{r}
# Generate an isoverse peak map
peaks_mapped <- peak_table %>%
  iso_map_peaks(peak_map, map_id = Analysis) %>%
  filter(!is.na(compound))
```

# Generation Time Calculations

```{r}
# Define a function to calculate turnover and generation time
# ARGUMENTS:
# FL = 0.005 # tracer strength = 0.5%
# a = 0.5 # incorporation efficiency of 50%
# FT = numeric # resulting isotopic enrichment
# F0 = numeric # beginning isotopic enrichment

gencalc <- function(a, FT, F0, FL, t) {
  case_when(
    t == 0 ~ NA_real_,
    TRUE ~ - (1/t)*(log((FT - a*FL)/(F0 - a*FL)))
  )
}

```

```{r}

# Add Some Metadata

mtda <- read_csv(file.path("data", "sample_metadata_2021.csv"))
sample_names <- mtda$id1

peaks_mapped <- peaks_mapped %>% 
  filter(sample_id %in% sample_names)

peaks_mapped <- peaks_mapped %>% 
  group_by(sample_id) %>% 
  mutate(inc_time_d = as.numeric(substr(sample_id, 4,4)),
         inc_time_d_str = paste(inc_time_d, "Days"),
         f_label = 0.005,
         t_series_id = paste0(substr(sample_id, 1,1), 
                              substr(sample_id, 5,5)))

inc_time_zero <- peaks_mapped %>% 
  filter(inc_time_d == 0) %>% 
  select(sample_id, compound, at2H) %>% 
  mutate(f_start = at2H)
         # extract first and lass code of sample_id
         



  
```


  
```{r}
peaks_mapped <- peaks_mapped %>%
  group_by(sample_id) %>%
  mutate(f_start = case_when(
           inc_time_d == 0 ~ at2H,
           inc_time_d != 0 ~ inc_time_zero$at2H
           ),
         terrain = case_when(
           substr(sample_id, 1, 1) == "t" ~ "Niwot Ridge Tundra",
           substr(sample_id, 1 ,1) == "c" ~ "Gordon Gulch Conifer Forest",
           substr(sample_id, 1 ,1) == "m" ~ "Gordon Gulch Meadow",
           substr(sample_id, 1 ,1) == "g" ~ "Marshall Mesa Grassland"))

peaks_mapped <- peaks_mapped %>% 
  mutate(rel_amount = area2 / sum(area2[compound != "IS"]))
```

## Remove standards from gencalcs
```{r}
# Don't want our standard compounds to be used for generation time calculations! x_x
peaks_mapped_active <- peaks_mapped %>% 
  filter(str_detect(compound, "STD", negate = TRUE))
```

Generation time is related to the turnover rate as below:
$$
g = \frac{ln(2)}{\mu}
$$

```{r}
gen_calc_data <- peaks_mapped_active %>% 
  select(c(Analysis, compound, d2H, at2H, sample_id, inc_time_d, inc_time_d_str, terrain, f_start, rel_amount)) %>% 
  mutate(
    at2H_label = 0.005,
    f_label = 0.5, # label is 0.5 at%
    a = 0.5, # assimilation efficiency
    t0 = 0, # start time
    d_t = inc_time_d - t0, # change in time
    f_t = at2H, # restate 2F at time t
    u_d = gencalc(a = 0.5, # Assimilation efficiency
                  FT = f_t, # 2F at time t (at%)
                  F0 = f_start, # 2F at t0 (at%)
                  FL = f_label, # 2F of label (at%)
                  t = d_t), # change in time
         # Returns turnover (Âµ) in days^-1
         gen_d = log(2) / u_d # calculate generation time
  )
```


```{r}
peaks_mapped_active %>% ggplot(
  aes(x = inc_time_d, y = at2H, color = compound, group = compound)) +
  geom_point() +
  geom_borderline() +
  scale_color_viridis_d() +
  theme_minimal()
```

## Chromatogram scaled by 2F

```{r "shaded chromatogram", fig.width=8, fig.height=8}
p_peaks_mapped_active <- peaks_mapped_active %>% ggplot(
  aes(x = rt, y = amp2, fill = as.numeric(at2H), label = compound)) +
  geom_col(aes(width = rt_end - rt_start)) +
  scale_fill_viridis_c(option = "magma") +
  facet_wrap(~inc_time_d_str, ncol = 1) +
  geom_text_repel(size = 2, box.padding = 0.5, nudge_y = 150) +
  theme_classic() +
  coord_cartesian(ylim = c(0, 1300)) +
  labs(fill = TeX("$^2F$"),
         x = "Retention Time (s)",
         y = "Amplitude (mV)") +
  theme(strip.background = element_blank())

```

```{r}
p_gen_time_dist <- gen_calc_data %>% filter(inc_time_d != 0) %>% 
  ggplot(
  aes(x = gen_d, 
      y = inc_time_d_str, 
      color = inc_time_d_str, 
      fill = inc_time_d_str)) +
  stat_slab(height = 0.3, alpha = 0.7) +
  stat_pointinterval(color = "black") +
  geom_point(
    color = "black",
    shape = 124,
    size = 3,
    alpha = 1,
    position = position_nudge(y = .03)) +
  geom_text_repel(aes(label = compound), 
                  color = "black", 
                  nudge_y = -0.3, 
                  size = 3) +
  scale_x_log10() +
  annotation_logticks(sides = "b") +
  scale_fill_npg() +
  scale_color_npg() +
  theme_classic() +
  labs(x = "Generation time (days)",
       y = "Incubation time",
       title = "Generation times of soil bacteria",
       subtitle = "Lipid-specific generation times of bacteria collected from Alpine Tundra",
       caption = "Soils collected from Niwot Ridge LTER") +
  theme(legend.position = "none",
        axis.ticks.y = element_blank())
p_gen_time_dist

#ggsave("fig_output/p_gen_times_dist.png", plot = p_gen_time_dist, height = 6, width = 8, dpi = 300)
```

# GC-FID Data

## Import GC-FID Data
```{r}
root <- file.path("data", "gc_fid_data_2020")
file_list = list.files(path = root)
file_list <- file_list %>% 
  str_subset("blank", negate = TRUE) %>% 
  str_subset("Blank", negate = TRUE) %>% 
  str_subset("GCMS-STD", negate = TRUE) %>% 
  str_subset("BLK", negate = TRUE) # remove procedural blanks
sample_names <- file_list %>% 
  str_replace("FID.....", "") %>% 
  str_replace("_100ul-nhex.xls", "") %>% 
  str_replace("_100ul.xls", "")

all_data <-
  tibble(
    sample = sample_names,
    file = file_list,
    data = map(file.path(root, file), read_chromeleon_export),
    injection_details = map(data, "injection_details"),
    integration_results = map(data, "integration_results")
  ) %>% select(-data)
```

## Unnest integration details

```{r}
results <- all_data %>% 
  select(-injection_details) %>% 
  unnest(integration_results) %>% 
  filter(nchar(`Peak Name`) > 0) %>% 
  # major compound groups
  mutate(
    group = `Peak Name` %>% str_remove("\\d+-OH") %>% parse_number() %>% abs() %>% {paste0("C", .)} %>% factor()
  )
```

```{r}
# Combine triplicate samples into one
results_trip <- results %>% 
  # Remove standards and fractions
  filter(sample != "FAME37.1") %>% 
  filter(sample != "TCBAME-2") %>% 
  filter(!str_detect(sample, "F1")) %>% 
  filter(!str_detect(sample, "F2")) %>% 
  filter(!str_detect(sample, "F3")) %>% 
  filter(!str_detect(sample, "cr")) %>%
  mutate(sample_rep = str_remove(sample, "[xyz]")) %>% 
  group_by(sample_rep, `Peak Name`) %>%
  # Generate summary stats
  summarize(rel_area_max = max(`Relative Area`, na.rm=TRUE),
            rel_area_min = min(`Relative Area`, na.rm=TRUE),
            rel_height_max = max(`Relative Height`, na.rm=TRUE),
            rel_height_min = min(`Relative Height`, na.rm=TRUE),
            `Retention Time` = mean(`Retention Time`, na.rm=TRUE),
            `Relative Area` = mean(`Relative Area`, na.rm=TRUE),
            `Relative Height` = mean(`Relative Height`, na.rm=TRUE)) %>% 
  # Add some basic metadata
  mutate(inc_time = case_when(
    str_detect(sample_rep, "...0") ~ 0,
    str_detect(sample_rep, "...3") ~ 3,
    str_detect(sample_rep, "...7") ~ 7),
    site = case_when(
      str_detect(sample_rep, "c") ~ "Conifer",
      str_detect(sample_rep, "t") ~ "Tundra",
      str_detect(sample_rep, "g") ~ "Grassland",
      str_detect(sample_rep, "m") ~ "Meadow")
  )
```

## PLFA Summary Plot
```{r}
p_72hr_FAs <- results_trip %>% filter(inc_time == "3") %>% 
  # Remove Standard Peaks
  #filter(str_detect(`Peak Name`, c("PAIBE", "21:0 (STD)", "23:0 (STD)"), negate = TRUE)) %>% 
  filter(`Peak Name` %nin% c("PAIBE", "21:0 (STD)", "23:0 (STD)")) %>% 
  ggplot(aes(x = `Retention Time`, 
             y = `Relative Area`, 
             color = sample_rep, 
             fill = sample_rep, 
             label = `Peak Name`)) +
  geom_col(width = 0.08) +
  geom_errorbar(aes(ymin=rel_area_min, 
                    ymax = rel_area_max), 
                color = "black", 
                width = 0.05) +
  facet_wrap(~sample_rep, 
             ncol = 1, 
             scales = "free_y") +
  geom_label_repel(fill = "black", 
                   color = "white", 
                   alpha = 0.7, 
                   size = 3, 
                   nudge_y = 2, 
                   segment.color = "black") +
  ggtitle("PLFA Profile: 72hr") +
  theme_bw() +
  scale_color_jama() +
  scale_fill_jama()
p_72hr_FAs
```

### IRMS relabund
```{r}
peaks_mapped_active %>% ggplot(aes(x = rt, y = rel_amount, fill = inc_time_d_str, color = inc_time_d_str)) +
  geom_col() +
  facet_wrap(~inc_time_d_str, ncol = 1)
```

### Relabund vs. activity
```{r}
gen_calc_data %>%
  filter(inc_time_d != 0) %>% 
  ggplot(
  aes(x = rel_amount, 
      y = u_d, 
      color = inc_time_d_str, 
      label = compound)) +
  geom_point() +
  geom_smooth(method = "lm",
              se = FALSE,
              formula = "y~x") +
  geom_line(aes(group = compound), 
            color = "black", 
            alpha = 0.3) +
  geom_text_repel(size = 3) +
  theme_classic() +
  scale_color_npg() +
  labs(x = "Relative Amount",
       y = "Turnover (d^-1)",
       color = "Incubation Time") +
  theme(legend.position = "top")
```

### Relabund vs. activity colored by 2F

```{r}
gen_calc_data %>%
  filter(inc_time_d != 0) %>% 
  ggplot(
  aes(x = rel_amount, 
      y = u_d, 
      color = as.numeric(f_t), 
      label = compound)) +
  geom_point(aes(shape = inc_time_d_str)) +
  geom_smooth(method = "lm",
              se = FALSE,
              formula = "y~x") +
  geom_line(aes(group = compound), 
            color = "black", 
            alpha = 0.3) +
  geom_text_repel(color = "black", 
                  size = 3) +
  scale_color_viridis_c(option = "magma") +
  theme_classic() +
  labs(x = "Relative Amount",
       y = "Turnover (d^-1)",
       shape = "Incubation Time",
       color = "2F") +
  theme(legend.position = "bottom")
```


## Merge IRMS and FID data

### PICK UP HERE: how do we match GC-FID compound data with IRMS compound data?

```{r}
results_trip_matched <- results_trip %>% 
  filter(`Peak Name` %in% gen_calc_data$compound)

matched_idx <- match(gen_calc_data$compound, results_trip_matched$`Peak Name`)
results_trip_matched$`Peak Name`[matched_idx]

combined_irms_fid <- gen_calc_data %>%
  group_by(terrain) %>% 
  mutate(relative_area = results_trip$`Relative Area`[""])
```

