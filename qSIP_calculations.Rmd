---
title: "2H qSIP Calculations"
author: "Tristan Caro"
date: "`r Sys.Date()`"
output:
    html_document:
    code_folding: show
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
# global knitting options for code rendering
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")

# global knitting options for automatic saving of all plots as .png and .pdf
knitr::opts_chunk$set(
  dev = c("png", "pdf"),
  dev.args = list(pdf = list(encoding = "WinAnsi", useDingbats = FALSE)),
  fig.keep = "all",
  fig.path = file.path("fig_output", paste0(gsub("\\.[Rr]md", "", knitr::current_input()), "_"))
)
```

# Load packages

```{r, message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)    # CRAN v1.3.1
library(forcats)      # CRAN v0.5.1 
library(isoreader)    # [::NA/NA] v1.3.0 # CRAN v1.3.0
library(isoprocessor) # [github::isoverse/isoprocessor] v0.6.7
library(isotopia)     # [github::isoverse/isotopia] v0.5.8 
library(readxl)       # CRAN v1.3.1 
library(ggsci)        # CRAN v2.9 
library(ggborderline) # [github::wurli/ggborderline] v0.1.0
library(ggrepel)      # CRAN v0.9.1 
library(latex2exp)    # CRAN v0.5.0
library(ggdist)       # CRAN v3.0.0 
library(ggsignif)     # CRAN v0.6.2
library(ggridges)     # CRAN v0.5.3
library(cowplot)      # CRAN v1.1.1

# Sourced Functions
source(file.path("libs", "visualization.R"))
source(file.path("libs", "chromleon.R"))
`%nin%` = Negate(`%in%`)
```

This analysis was run using [isoreader](http://isoreader.kopflab.org) version `r packageVersion("isoreader")` and [isoprocessor](http://isoprocessor.kopflab.org/) version `r packageVersion("isoprocessor")`. 

# Turnover Calculation Function

```{r}
# Define a function to calculate turnover and generation time
# ARGUMENTS:
# FL = 0.005 # tracer strength = 0.5%
# a = 0.5 # incorporation efficiency of 50%
# FT = numeric # resulting isotopic enrichment
# F0 = numeric # beginning isotopic enrichment

gencalc <- function(a, FT, F0, FL, t) {
  case_when(
    t == 0 ~ NA_real_,
    TRUE ~ - (1/t)*(log((FT - a*FL)/(F0 - a*FL)))
  )
}

```

# Load data

## Load IRMS Data

### Load Metadata and Problematic Run Data

```{r}
mtda <- read_csv(file.path("data", "sample_metadata_2021.csv"))
sample_names <- mtda$id1

problematic_runs <- read_xlsx(file.path("data", "IRMS", "problematic_runs.xlsx"))
problematic_analyses <- problematic_runs$Analysis
problematic_analyses_num <- parse_number(problematic_analyses)
```

### Load Peak Map

```{r}
# this information is often maintained in a csv or Excel file
peak_map <- 
  # initial peak map:
  # readxl::read_excel(file.path("data","IRMS", "peak_map_manual_general.xlsx"))
  # corrected peak map
  readxl::read_excel(file.path("data", "IRMS", "peak_maps_resolved.xlsx"))
peak_map
```

### Read raw IRMS data files

```{r, warning=FALSE}
# Set file path(s) to data files, folders or rds collections 
# can be multiple folders or mix of folders and files
# Isoverse will iteratively search subfolders. Huzzah! ^_^
data_path <- file.path("data", "IRMS", "raw_data")
ref_ratio <- get_standard("2H") %>% as.numeric()

# read files
iso_files_raw <- 
  # path to data files
  data_path %>% 
  # read data files in parallel for fast read
  iso_read_continuous_flow() %>%
  # filter out files with read errors (e.g. from aborted analysis)
  iso_filter_files_with_problems()
```

### Process file info & peak table

```{r}
# process file information
iso_files <- iso_files_raw %>% 
  # rename key file info columns
  iso_rename_file_info(analysis = Analysis, id1 = `Identifier 1`, id2 = `Identifier 2`) %>% 
  # parse text info into numbers
  iso_parse_file_info(number = analysis) %>% 
  # process other file information that is specific to the naming conventions
  # of this particular sequence
  iso_mutate_file_info(
    # what is the type of each analysis?
    type = case_when(
      str_detect(id1, "[Zz]ero")      ~ "on_off",
      str_detect(id1, "H3")           ~ "H3_factor",
      str_detect(id1, "F8")           ~ "F8_std",
      str_detect(id1, "F9")           ~ "F9_std",
      TRUE                            ~ "sample"
    ),
    # what was the concentration? (assuming Preparation = concentration or volume)
    concentration = 
      ifelse(type == "std",  
             str_extract(Preparation, "[0-9.]+ ?ng( per |/)uL") %>% 
               parse_number() %>% iso_double_with_units("ng/uL"),
             NA),
    # what folder are the data files in? (assuming folder = sequence)
    folder = basename(dirname(file_path))
  ) %>% 
  # focus only on the relevant file info, discarding the rest
  iso_select_file_info(
    folder, analysis, file_datetime, id1, type, concentration
  ) %>% 
  # add in additional sample metadata (could be any info)
  # note: this would typically be stored in / read from a csv or excel file
  iso_add_file_info(
    read_csv(file.path("data", "sample_metadata_2021.csv")),
    join_by = "id1"
  )

# set peak table from vendor data table with default isodat template
iso_files <- iso_set_peak_table_from_isodat_vendor_data_table(iso_files) %>% 
  # convert units from mV to V for amplitudes and area
  iso_convert_peak_table_units(V = mV, Vs = mVs)

# focus on sample files
sample_files <- iso_filter_files(iso_files, type == "sample")

# # EXCLUDE C26 ALKANE STANDARD
# sample_files <- iso_filter_files(sample_files, str_detect(id1, "C26", negate = TRUE))
# 
# # EXCLUDE SQUALANE STANDARD
# sample_files <- iso_filter_files(sample_files, str_detect(id1, "squalane", negate = TRUE))
# 
# # EXCLUDE BLANKS AND TESTS
# sample_files <- iso_filter_files(sample_files, str_detect(id1, "blank", negate = TRUE))
# sample_files <- iso_filter_files(sample_files, str_detect(id1, "BLANK", negate = TRUE))
# sample_files <- iso_filter_files(sample_files, str_detect(id1, "H2", negate = TRUE))
# sample_files <- iso_filter_files(sample_files, str_detect(id1, "nhex", negate = TRUE))
# sample_files <- iso_filter_files(sample_files, str_detect(id1, "cleaning", negate = TRUE))
# 
# # EXCLUDE BAME STANDARD
# sample_files <- iso_filter_files(sample_files, str_detect(id1, "BAME", negate = TRUE))
# 
# # EXCLUDE F HEAVY
# sample_files <- iso_filter_files(sample_files, str_detect(id1, "F_HEAVY", negate = TRUE))
# 

# Include only sample files
 sample_files <- iso_filter_files(sample_files, id1 %in% sample_names)

# EXCLUDE CRC SAMPLES FROM THIS ANALYSIS
sample_files <- iso_filter_files(sample_files, str_detect(id1, "cri", negate = TRUE))

sample_files <- iso_filter_files(sample_files, str_detect(id1, "cr0", negate = TRUE))

# EXCLUDE RUN WE'VE DEEMED PROBLEMATIC
sample_files <- iso_filter_files(sample_files, analysis %nin% problematic_analyses_num)

```

### Show file information

```{r}
# display file information
iso_files %>% 
  iso_get_file_info() %>% select(-file_id, -folder) %>% 
  iso_make_units_explicit() %>% knitr::kable()
```



### Example chromatograms

```{r "example_chromatograms", fig.width=8, fig.height=8}
# plot an example chromatogram

# sample_files[10] %>% # choosing arbitrary file to plot
# iso_plot_continuous_flow_data(
#   # select data and aesthetics
#   data = c(2), color = id1, panel = id1,
#   # zoom in on time interval
#   time_interval = c(750, 4000),
#   # peak labels for all peaks > 2V
#   peak_bounds = TRUE,
#   peak_marker = FALSE,
#   peak_label = iso_format(rt),
#   #peak_label_size = 3,
#   peak_label_filter = analysis == 5685 & amp2 > 1
# ) + scale_color_npg() + 
#   theme_classic() +
#   theme(strip.background = element_blank())
```


## Import GC-FID Data
```{r}
root <- file.path("data", "gc_fid_data_2020")
file_list = list.files(path = root)
file_list <- file_list %>% 
  str_subset("blank", negate = TRUE) %>% 
  str_subset("Blank", negate = TRUE) %>% 
  str_subset("GCMS-STD", negate = TRUE) %>% 
  str_subset("BLK", negate = TRUE) # remove procedural blanks
sample_names <- file_list %>% 
  str_replace("FID.....", "") %>% 
  str_replace("_100ul-nhex.xls", "") %>% 
  str_replace("_100ul.xls", "")

FID_all_data <-
  tibble(
    sample = sample_names,
    file = file_list,
    data = map(file.path(root, file), read_chromeleon_export),
    injection_details = map(data, "injection_details"),
    integration_results = map(data, "integration_results")
  ) %>% select(-data)
```

### Unnest FID integration details

```{r}
FID_results <- FID_all_data %>% 
  select(-injection_details) %>% 
  unnest(integration_results) %>% 
  filter(nchar(`Peak Name`) > 0) %>% 
  # Specify chain length
  mutate(
    chain = `Peak Name` %>% 
      str_remove("\\d+-OH") %>% 
      parse_number() %>% 
      abs() %>% 
      {paste0("C", .)} %>% 
      factor()
      ) %>% 
  # Rename these columns so we can join the IRMS and FID data
  # Important to specify what data comes from FID!
  rename("sample_id" = sample,
         "compound" = `Peak Name`,
         "rt_FID" = `Retention Time`,
         "area_FID" = `Area`,
         "height_FID" = `Height`,
         "rel_area_FID" = `Relative Area`,
         "rel_height_FID" = `Relative Height`,
         "amount_FID" = `Amount`
         )
```


# Peak Mapping

```{r}
sample_peak_table <- sample_files %>%
  iso_set_peak_table_from_isodat_vendor_data_table() %>%
  iso_get_peak_table() %>% 
  mutate(Analysis = substr(file_id, 1, 7),
         sample_id = substr(file_id, 10,14))
```

## Generate Isoverse Peak Map
```{r}
# Generate an isoverse peak map
peaks_mapped <- sample_peak_table %>%
  iso_map_peaks(peak_map, map_id = Analysis) %>%
  filter(!is.na(compound))
```

## Remove readychecks, blanks, etc. from analysis
```{r}
# Filter based on what is in the sample_names metadata
peaks_mapped <- peaks_mapped %>% 
  filter(sample_id %in% sample_names)

# Filter out runs that are on our problematic_runs list
peaks_mapped <- peaks_mapped %>% 
  filter(Analysis %nin% problematic_runs)
```

## Check problematic peak assignments
```{r}
problem_peaks <- iso_get_problematic_peak_mappings(peaks_mapped)
```


## Export summary of unresolved peaks
```{r}
# Spit out peaks that need to be resolved
peaks_mapped %>%
  ungroup() %>%
  select(Analysis, compound, rt) %>%
  mutate(rt = round(rt, digits=0)) %>%
  pivot_wider(
    names_from = Analysis, 
    names_prefix = "rt:",
    values_from = rt, 
    id_cols = compound, 
    values_fn = function(x) paste(x, collapse = "; ")
  ) %>%
  openxlsx::write.xlsx(file.path("data", "IRMS", "peak_maps_resolve.xlsx"))
```

## Assign incubation params
```{r}

# Add Some Parameters
peaks_mapped <- peaks_mapped %>% 
  group_by(sample_id) %>% 
  mutate(inc_time_d = as.numeric(substr(sample_id, 4,4)),
         inc_time_d_str = paste(inc_time_d, "Days"),
         f_label = 0.005,
         t_series_id = paste0(substr(sample_id, 1,1), 
                              substr(sample_id, 5,5)),
         soil_id = substr(t_series_id, 1,1),
         replicate_id = substr(t_series_id, 2,2),
         terrain = case_when(
           substr(sample_id, 1, 1) == "t" ~ "Niwot Ridge Tundra",
           substr(sample_id, 1 ,1) == "c" ~ "Gordon Gulch Conifer Forest",
           substr(sample_id, 1 ,1) == "m" ~ "Gordon Gulch Meadow",
           substr(sample_id, 1 ,1) == "g" ~ "Marshall Mesa Grassland"))
# 
# inc_time_zero <- peaks_mapped %>% 
#   filter(inc_time_d == 0) %>% 
#   select(sample_id, compound, at2H, t_series_id) %>% 
#   mutate(f_start = at2H) %>% 
#   select(-at2H)
# 
#   

  
```

## Extract zero timepoint values
```{r}
zero_peaks <- peaks_mapped %>%
  filter(inc_time_d_str == "0 Days") %>%
  group_by(t_series_id, compound) %>%
  mutate(n_analyical_reps = n()) %>%
  ungroup() %>%
  # exclude ambiguous peaks
  filter(!is_ambiguous)

zero_peaks_averaged <- zero_peaks %>% 
  group_by(soil_id, compound) %>% 
  summarise(at2H_mn_zero = mean(at2H),
            d2H_mn_zero = mean(d2H),
            area2_mn_zero = mean(area2))
  
zero_peaks_averaged %>% 
  openxlsx::write.xlsx(file.path("data", "IRMS", "zero_peaks_averaged.xlsx"),
                       overwrite = TRUE)

# zero_peaks_averaged <- read_xlsx(file.path("data", "IRMS", "zero_peaks_averaged.xlsx"))


# This is the dataset we will use for generation time calculations
peaks_mapped_with_zeros <- 
  peaks_mapped %>%
  left_join(
    zero_peaks_averaged,
    by = c("soil_id", "compound")
  )
stopifnot(nrow(peaks_mapped_with_zeros) == nrow(peaks_mapped))

# no zero samples
# peaks_mapped_with_zeros %>% filter(is.na(zero_sample_id)) %>% View()

peaks_mapped_with_zeros <- peaks_mapped_with_zeros %>% 
  mutate(
    sample_id = substr(file_id, 10,14)
    )
```


## Join IRMS and GC-FID Data

```{r}
peaks_mapped_with_zeros_FID <- peaks_mapped_with_zeros %>% 
  left_join(FID_results, by = c("sample_id", "compound"))
```

```{r}
# Combine triplicate samples into one
FID_results_trip <- FID_results %>% 
  # Remove standards and fractions
  filter(sample_id != "FAME37.1") %>% 
  filter(sample_id != "TCBAME-2") %>% 
  filter(!str_detect(sample_id, "F1")) %>% 
  filter(!str_detect(sample_id, "F2")) %>% 
  filter(!str_detect(sample_id, "F3")) %>% 
  filter(!str_detect(sample_id, "cr")) %>%
  mutate(sample_rep = str_remove(sample_id, "[xyz]")) %>% 
  group_by(sample_rep, compound) %>%
  # Generate summary stats
  summarize(rel_area_FID_max = max(rel_area_FID, na.rm=TRUE),
            rel_area_FID_min = min(rel_area_FID, na.rm=TRUE),
            rel_height_FID_max = max(rel_height_FID, na.rm=TRUE),
            rel_height_FID_min = min(rel_height_FID, na.rm=TRUE),
            rt_FID = mean(rt_FID, na.rm=TRUE),
            rel_area_FID = mean(rel_area_FID, na.rm=TRUE),
            rel_height_FID = mean(rel_height_FID, na.rm=TRUE)) %>% 
  # Add some basic metadata
  mutate(inc_time = case_when(
    str_detect(sample_rep, "...0") ~ 0,
    str_detect(sample_rep, "...3") ~ 3,
    str_detect(sample_rep, "...7") ~ 7),
    site = case_when(
      str_detect(sample_rep, "c") ~ "Conifer",
      str_detect(sample_rep, "t") ~ "Tundra",
      str_detect(sample_rep, "g") ~ "Grassland",
      str_detect(sample_rep, "m") ~ "Meadow")
  )
```


## Remove standards from gencalcs
```{r}
# Don't want our standard compounds to be used for generation time calculations! x_x
peaks_mapped_with_zeros_analytes <- peaks_mapped_with_zeros_FID %>% 
  filter(str_detect(compound, "STD", negate = TRUE))
```

## Summarize Analytical and Experimental Replicates

```{r}
peaks_mapped_summarized <- peaks_mapped_with_zeros_analytes %>% 
  group_by(terrain, inc_time_d, compound) %>% 
  summarize_if(is.numeric, mean, na.rm = TRUE)
```

## Weighted turnover over time course

```{r}
# Take peaks_mapped_summarized (which is the dataframe of IRMS values averaged across
# experimental and analytical replicates).
# Determine the weighted at2H, which is the sum of at2H values times relative area 
# divided by total area.

weighted_time_course <- peaks_mapped_summarized %>% 
  group_by(terrain, inc_time_d) %>%
  summarize(at2H_weighted = sum(at2H * rel_area_FID, na.rm = TRUE) / sum(rel_area_FID, na.rm = TRUE))
  
peaks_mapped_summarized <- left_join(peaks_mapped_summarized, 
                                     weighted_time_course,
                                     by = c("terrain", "inc_time_d"))
  
```



## Calculate turnover time
Turnover is calculated as below:

$$
\mu = - \frac{1}{t} \cdot (ln (\frac{F_T - a \cdot F_L}{F_0 - a \cdot F_L})
$$

```
# R code:
gencalc <- function(a, FT, F0, FL, t) {
  case_when(
    t == 0 ~ NA_real_,
    TRUE ~ - (1/t)*(log((FT - a*FL)/(F0 - a*FL)))
  )
}

```

Generation time is related to the turnover rate as below:
$$
g = \frac{ln(2)}{\mu}
$$

```{r}
gen_calc_data <- peaks_mapped_with_zeros_analytes %>% 
  mutate(
    f_label = 0.5, # label is 0.5 at%
    a = 0.5, # assimilation efficiency
    t0 = 0, # start time
    f_start = at2H_mn_zero,
    d_t = inc_time_d - t0, # change in time
    f_t = at2H, # restate 2F at time t
    u_d = gencalc(a = 0.5, # Assimilation efficiency
                  FT = f_t, # 2F at time t (at%)
                  F0 = f_start, # 2F at t0 (at%)
                  FL = f_label, # 2F of label (at%)
                  t = d_t), # change in time
    # "negative" turnovers are artifacts of noise and should be zero
    u_d = if_else(u_d < 0, 0, u_d),
    # calculate generation time, converting negatives to zero
    gen_d = if_else(u_d < 0, 0, log(2) / u_d)
  ) %>%
  mutate(
    chain_fctr = compound %>% 
      str_remove("\\d+-OH") %>% 
      parse_number() %>% 
      abs() %>% 
      {paste0("C", .)} %>% 
      factor()
      ) %>% 
  mutate(
    chain_num = compound %>% 
      str_remove("\\d+-OH") %>% 
      parse_number() %>% 
      abs()
  )
```

```{r}

gen_calc_data_summarized <- peaks_mapped_summarized %>% 
  mutate(
    f_label = 0.5, # label is 0.5 at%
    a = 0.5, # assimilation efficiency
    t0 = 0, # start time
    f_start = at2H_mn_zero,
    d_t = inc_time_d - t0, # change in time
    f_t = at2H, # restate 2F at time t
    u_d = gencalc(a = 0.5, # Assimilation efficiency
                  FT = f_t, # 2F at time t (at%)
                  F0 = f_start, # 2F at t0 (at%)
                  FL = f_label, # 2F of label (at%)
                  t = d_t), # change in time (d)
    # "negative" turnovers are artifacts of noise and should be zero
    u_d = if_else(u_d < 0, 0, u_d),
    # calculate generation time, converting negatives to zero
    gen_d = if_else(u_d < 0, 0, log(2) / u_d),
    # calculate weighted turnover rates
    u_d_weighted = gencalc(a = 0.5, # Assimilation efficiency
                           FT = at2H_weighted, # weighted 2F (at%)
                           F0 = f_start, # 2F at t0 (at%)
                           FL = f_label, # 2F of label (at%)
                           t = d_t # change in time (d)
                           ),
    # "negative" turnovers are artifacts of noise and should be zero
     u_d_weighted = if_else(u_d_weighted < 0, 0, u_d_weighted),
    # calculate generation time, converting negatives to zero
     gen_d_weighted = if_else(u_d_weighted < 0, 0, log(2) / u_d_weighted),
  ) %>%
  mutate(
    chain_fctr = compound %>% 
      str_remove("\\d+-OH") %>% 
      parse_number() %>% 
      abs() %>% 
      {paste0("C", .)} %>% 
      factor()
      ) %>% 
  mutate(
    chain_num = compound %>% 
      str_remove("\\d+-OH") %>% 
      parse_number() %>% 
      abs()
  )

# gen_calc_data_summarized %>% openxlsx::write.xlsx(file.path("data", "gen_calc_data_summarized.xlsx"))
```




# Save Workspace Image
Handoff to paper plotting script

```{r}
# This will take a minute. 
# Uncomment below to save the workspace image.
save.image(file = "cache/qSIP_calculations.RData")
```


# Practice Plotting


## Peak Tracer Incorporation
```{r}
peaks_mapped_with_zeros_analytes %>% ggplot(
  aes(x = inc_time_d, y = at2H, color = compound, group = compound)) +
  geom_point() +
  geom_smooth(se = FALSE,
              method = "lm") +
  #geom_borderline() +
  scale_color_viridis_d() +
  theme_minimal()
```

## Chromatogram scaled by 2F

```{r "shaded chromatogram", fig.width=8, fig.height=8}
p_peaks_mapped_active <- peaks_mapped_with_zeros_analytes %>% ggplot(
  aes(x = rt, y = amp2, fill = as.numeric(at2H), label = compound)) +
  geom_col(aes(width = rt_end - rt_start)) +
  scale_fill_viridis_c(option = "magma") +
  facet_wrap(~sample_id, ncol = 1) +
  geom_text_repel(size = 2, box.padding = 0.5, nudge_y = 150) +
  theme_classic() +
  coord_cartesian(ylim = c(0, 1300)) +
  labs(fill = TeX("$^2F$"),
         x = "Retention Time (s)",
         y = "Amplitude (mV)") +
  theme(strip.background = element_blank())

```


## Compound enrichment over time

```{r}
peaks_mapped_summarized %>% 
  mutate(compound = forcats::fct_reorder(compound, rt)) %>% 
  ggplot(aes(x = inc_time_d,
             y = at2H,
             group = compound)) +
  geom_borderline(color = "gray") +
  geom_point() +
  geom_line(aes(x = inc_time_d,
                y = at2H_weighted,
                color = terrain),
            size = .8) +
  geom_point(aes(x = inc_time_d,
                y = at2H_weighted, 
                color = terrain),
             shape = 18,
             size = 3) +
  geom_label_repel(data = peaks_mapped_summarized %>% filter(inc_time_d == 7),
                   nudge_x = 2,
                   nudge_y = 0.005,
                   size = 2.5,
                   aes(label = compound)) +
  geom_label_repel(data = weighted_time_course %>% filter(inc_time_d == 3),
                   aes(x = inc_time_d,
                       y = at2H_weighted,
                       group = terrain,
                       color = terrain),
                   label = "Weighted Mean",
                   nudge_y = -.01,
                   nudge_x = 1,
                   size = 2.5) +
  facet_wrap(vars(terrain), nrow = 1) +
  scale_x_continuous(breaks = c(0, 3, 7)) +
  scale_color_npg() +
  coord_cartesian(xlim = c(0, 10), clip = FALSE) +
  labs(x = "Incubation Time (Days)",
       y = TeX("% $^2H$"),
       color = "Soil Type") +
  theme_classic() +
  theme(legend.position = "none",
        strip.background = element_blank())

```

## Compound enrichment over time with label strength

```{r}
gen_calc_data_summarized %>% 
  filter(compound != "i-16:0") %>% 
  mutate(compound = fct_reorder(compound, rt)) %>% 
  ggplot(aes(x = inc_time_d,
             y = at2H,
             color = compound)) +
  geom_point() +
  geom_borderline() +
  geom_hline(yintercept = 0.5,
             color = "red") +
  facet_wrap(vars(terrain)) +
  scale_x_continuous(breaks = c(0, 3, 7)) +
  scale_color_viridis_d() +
  labs(x = "Incubation Time (Days)",
       y = "Mean %D") +
  theme_bw()
```


## Generation Time of All Points

```{r}
p_gen_time_dist <- gen_calc_data %>% 
  filter(inc_time_d != 0) %>% 
  ggplot(
  aes(y = gen_d, 
      x = inc_time_d_str, 
      color = inc_time_d_str, 
      fill = inc_time_d_str)) +
  stat_slab(width = 0.3, alpha = 0.7) +
  stat_pointinterval(color = "black") +
  # geom_boxplot(fill = "white",
  #              color = "black",
  #              width = 0.1,
  #              outlier.shape = NA) +
  geom_point(
    color = "black",
    shape = 95,
    size = 3,
    alpha = 0.5,
    position = position_nudge(x = -.03)) +
  # geom_text_repel(aes(label = compound), 
  #                 color = "black", 
  #                 nudge_y = -0.3, 
  #                 size = 3) +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  scale_fill_npg() +
  scale_color_npg() +
  theme_classic() +
  labs(y = "Generation time (days)",
       x = "Incubation time",
       title = "Generation times of soil bacteria",
       subtitle = "Lipid-specific generation times of bacteria",
       caption = "Soils collected from Colorado") +
  theme(legend.position = "none",
        axis.ticks.y = element_blank())
p_gen_time_dist

#ggsave("fig_output/p_gen_times_dist.png", plot = p_gen_time_dist, height = 6, width = 8, dpi = 300)
```

## Generation Time, all points, not separated by inc_time

```{r}
p_gen_time_dist_all <- gen_calc_data %>% filter(inc_time_d != 0) %>% 
  ggplot(
  aes(y = gen_d, 
      x = 1)) +
  stat_slab(width = 0.3, alpha = 0.7) +
  stat_pointinterval(color = "black") +
  # geom_boxplot(fill = "white",
  #              color = "black",
  #              width = 0.1,
  #              outlier.shape = NA) +
  geom_point(
    color = "black",
    shape = 95,
    size = 3,
    alpha = 0.5,
    position = position_nudge(x = -.03)) +
  # geom_text_repel(aes(label = compound), 
  #                 color = "black", 
  #                 nudge_y = -0.3, 
  #                 size = 3) +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  scale_fill_npg() +
  scale_color_npg() +
  theme_classic() +
  labs(y = "Generation time (days)",
       title = "Generation times of soil bacteria",
       subtitle = "Lipid-specific generation times of bacteria",
       caption = "Soils collected from Colorado") +
  theme(legend.position = "none",
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank())
p_gen_time_dist_all
```


## Generation Time, all points, not separated, > C19 removed

```{r}
p_gen_time_dist_all_no19 <- gen_calc_data %>% 
  filter(inc_time_d != 0,
         chain_num < 19) %>% 
  ggplot(
  aes(y = gen_d, 
      x = 1)) +
  stat_slab(width = 0.3, alpha = 0.7) +
  stat_pointinterval(color = "black") +
  # geom_boxplot(fill = "white",
  #              color = "black",
  #              width = 0.1,
  #              outlier.shape = NA) +
  geom_point(
    color = "black",
    shape = 95,
    size = 3,
    alpha = 0.5,
    position = position_nudge(x = -.03)) +
  # geom_text_repel(aes(label = compound), 
  #                 color = "black", 
  #                 nudge_y = -0.3, 
  #                 size = 3) +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  scale_fill_npg() +
  scale_color_npg() +
  theme_classic() +
  labs(y = "Generation time (days)",
       title = "Generation times of soil bacteria",
       subtitle = "Lipid-specific generation times of bacteria \nC20+ removed",
       caption = "Soils collected from Colorado") +
  theme(legend.position = "none",
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank())
p_gen_time_dist_all_no19
```


## Generation time of all points, not log scale

```{r}
p_gen_time_dist_all_lin <- gen_calc_data %>% 
  filter(inc_time_d != 0,
         gen_d >= 0,
         chain_num < 19) %>% 
  ggplot(
  aes(y = gen_d, 
      x = 1)) +
  stat_slab(width = 0.25, 
            alpha = 0.7,
            color = "black") +
  stat_pointinterval(color = "black") +
  # geom_boxplot(fill = "white",
  #              color = "black",
  #              width = 0.1,
  #              outlier.shape = NA) +
  geom_point(
    color = "black",
    shape = 95,
    size = 3,
    alpha = 0.5,
    position = position_nudge(x = -.03)) +
  # geom_text_repel(aes(label = compound), 
  #                 color = "black", 
  #                 nudge_y = -0.3, 
  #                 size = 3) +
  scale_fill_npg() +
  scale_color_npg() +
  theme_classic() +
  labs(y = "Generation time (days)",
       title = "Generation times of soil bacteria",
       subtitle = "Lipid-specific generation times of bacteria",
       caption = "Soils collected from Colorado") +
  theme(legend.position = "none",
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank())
p_gen_time_dist_all_lin
```


## Generation Time, Broken by Terrain

```{r}
signif_comparisons <- gen_calc_data %>% pull(terrain) %>% unique()

p_gen_time_terrain <- gen_calc_data %>% 
  filter(inc_time_d != 0,
         chain_num < 19) %>% 
  ggplot(
  aes(y = gen_d, 
      x = terrain,
      color = terrain,
      fill = terrain)) +
  stat_slab(width = 0.25, 
            alpha = 0.7,
            color = "black") +
  stat_pointinterval(color = "black") +
  # geom_boxplot(fill = "white",
  #              color = "black",
  #              width = 0.1,
  #              outlier.shape = NA) +
  geom_point(
    color = "black",
    shape = 95,
    size = 3,
    alpha = 0.5,
    position = position_nudge(x = -.07)) +
  geom_signif(comparisons = list(signif_comparisons),
              map_signif_level = TRUE) +
  scale_y_log10(breaks = c(1, 10, 100)) +
  annotation_logticks(sides = "l") +
  scale_fill_npg() +
  scale_color_npg() +
  theme_classic() +
  labs(y = "Generation time (days)",
       title = "Generation times of soil bacteria",
       subtitle = "Lipid-specific generation times of bacteria \nC20+ omitted") +
  theme(axis.ticks.y = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1))
p_gen_time_terrain
```

## Turnover time by compound

```{r}
gen_calc_data_summarized %>% 
  filter(inc_time_d != 0, compound != "i-16:0") %>%
  group_by(compound) %>% 
  summarize_if(is.numeric, mean, na.rm = TRUE) %>% 
  mutate(compound = fct_reorder(compound, u_d)) %>% 
  ggplot(aes(x = compound,
             y = u_d,
             fill = u_d)) +
  geom_col(position = "dodge") +
  scale_fill_viridis_c(option = "plasma") +
  labs(x = "Compound",
       y = "Mean Turnover time (d^-1)",
       title = "Compound-specific turnover rates of bacterial phospholipid fatty acids") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, 
                               hjust = 1)
  )
```

## Turnover Time, Broken By Terrain

```{r}
p_turnover_terrain <- gen_calc_data %>% filter(inc_time_d != 0) %>% 
  ggplot(
  aes(x = inc_time_d_str, 
      y = u_d, 
      color = terrain, 
      fill = terrain)) +
  #stat_slab(height = 0.3, alpha = 0.7) +
  stat_pointinterval(color = "black") +
  # geom_point(
  #   color = "black",
  #   #shape = 124,
  #   size = 1,
  #   alpha = 0.5,
  #   position = position_nudge(x = -.05)) +
  # geom_text_repel(aes(label = compound), 
  #                 color = "black", 
  #                 nudge_y = -0.3, 
  #                 size = 3) +
  facet_wrap(~terrain, nrow = 1) +
  scale_y_log10() +
  annotation_logticks(sides = "a") +
  scale_fill_npg() +
  scale_color_npg() +
  theme_bw() +
  labs(x = "Incubation Time",
       y = "Turnover Time (d^-1)",
       title = "Generation times of soil bacteria across terrain")
  theme(legend.position = "none",
        axis.ticks.y = element_blank())
p_turnover_terrain
```

## 7 Day Turnover Times By Terrain

```{r}
p_turnover_terrain_7d <- gen_calc_data %>% filter(inc_time_d == 7) %>% 
  ggplot(
  aes(x = terrain, 
      y = u_d)) +
  #stat_slab(height = 0.3, alpha = 0.7) +
  #stat_pointinterval(color = "black") +
  geom_boxplot(outlier.shape = NA) +
  geom_point(
    color = "black",
    #shape = 124,
    size = 1,
    alpha = 0.5) +
  geom_signif(comparisons = list(signif_comparisons),
              map_signif_level = TRUE) +
  scale_y_log10() +
  annotation_logticks(sides = "a") +
  scale_fill_npg() +
  scale_color_npg() +
  theme_bw() +
  labs(x = "Terrain",
       y = "Turnover time (d^-1)",
       title = "Generation times of soil bacteria across terrain") +
  theme(legend.position = "none",
        axis.ticks.y = element_blank())
p_turnover_terrain_7d
```

## 7 Day Generation Times across terrain

```{r}
p_gen_time_terrain_7d <- gen_calc_data %>% filter(inc_time_d == 7) %>% 
  ggplot(
  aes(x = terrain, 
      y = gen_d)) +
  #stat_slab(height = 0.3, alpha = 0.7) +
  #stat_pointinterval(color = "black") +
  geom_boxplot(outlier.shape = NA) +
  geom_point(
    color = "black",
    #shape = 124,
    size = 1,
    alpha = 0.5) +
  # geom_text_repel(aes(label = compound), 
  #                 color = "black", 
  #                 nudge_y = -0.3, 
  #                 size = 3) +
  scale_y_log10() +
  annotation_logticks(sides = "a") +
  scale_fill_npg() +
  scale_color_npg() +
  theme_bw() +
  labs(x = "Terrain",
       y = "Turnover time (d^-1)",
       title = "Generation times of soil bacteria across terrain") +
  theme(legend.position = "none",
        axis.ticks.y = element_blank())
p_gen_time_terrain_7d
```

## Turnover time versus lipid relative abundance

```{r}

gen_calc_data %>% 
  filter(inc_time_d != 0) %>% 
  ggplot(aes(x = rel_area_FID,
             y = u_d)) +
  geom_point(aes(color = chain_fctr)) +
  geom_smooth(method = "lm",
              se = FALSE) +
  scale_color_viridis_d() +
  facet_wrap(~terrain) +
  labs(x = "Relative Area (GC-FID)",
       y = "Turnover (d^-1)",
       color = "Compound class") +
  theme_bw()

```

## Compound-Specific Enrichment

```{r}
gen_calc_data %>% 
  mutate(compound = fct_reorder(compound, -chain_num)) %>% 
  ggplot(aes(x = at2H,
             y = compound,
             fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3) +
  # Vline showing enrichment strength
  # geom_vline(xintercept = 0.5,
  #            color = "red") +
  facet_wrap(vars(inc_time_d_str), ncol = 1) +
  scale_fill_viridis_c(option = "C") +
  labs(fill = "% D",
       x = "% D",
       y = "Compound") +
  theme_ridges() +
  theme(axis.text.y = element_text(size = 5),
        legend.position = "right",
        legend.key.width = unit(0.2, "line"),
        legend.text = element_text(size = 10))
```

## Compound specific turnover
```{r}
gen_calc_data %>% 
  mutate(compound = fct_reorder(compound, -chain_num)) %>% 
  ggplot(aes(x = u_d,
             y = compound,
             fill = stat(x))) +
  geom_density_ridges_gradient() +
  # Vline showing enrichment strength
  facet_wrap(vars(inc_time_d_str), ncol = 1) +
  scale_fill_viridis_c(option = "C") +
  labs(fill = "µ (d^-1)",
       x = "µ (d^-1)",
       y = "Compound") +
  theme_minimal()
```

## Mean Turnover by Terrain

```{r}
gen_calc_data_summarized %>% 
  group_by(inc_time_d, terrain) %>% 
  summarize(u_d_mn = mean(u_d),
            u_d_max = max(u_d),
            u_d_min = min(u_d),
            gen_d_mn = mean(gen_d),
            gen_d_max = max(gen_d),
            gen_d_min = min(gen_d)) %>% 
  ggplot(aes(x = terrain, 
             y = u_d_mn,
             color = as.character(inc_time_d))) +
  geom_path(color = "black") +
  geom_point() +
  coord_cartesian(ylim = c(0, 0.05)) +
  labs(x = "Terrain",
       y = "Mean Turnover (d^-1)",
       color = "Incubation Time") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Mean Turnover Aggregated

```{r}
gen_calc_data_summarized %>% 
  # Calculate means, by terrain
  group_by(inc_time_d, terrain) %>% 
  summarize(u_d_mn = mean(u_d),
            u_d_max = max(u_d),
            u_d_min = min(u_d),
            gen_d_mn = mean(gen_d),
            gen_d_max = max(gen_d),
            gen_d_min = min(gen_d)) %>% 
  # Calculate mean of means
  group_by(inc_time_d) %>% 
  summarize(u_d_mn_ag = mean(u_d_mn),
            u_d_max_ag = max(u_d_mn),
            u_d_min_ag = min(u_d_mn),
            gen_d_mn_ag = mean(gen_d_mn),
            gen_d_max_ag = max(gen_d_mn),
            gen_d_min_ag = min(gen_d_mn)) %>% 
  ggplot(aes(x = 1, 
             y = u_d_mn_ag,
             color = as.character(inc_time_d))) +
  geom_path(color = "black") +
  geom_point() +
  coord_cartesian(ylim = c(0, 0.05)) +
  labs(x = "Terrain",
       y = "Mean Turnover (d^-1)",
       color = "Incubation Time") +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())
  
```


## Literature Rates of Cell Turnover

```{r}
# Import lit search data
lit_turnover <- read_xlsx(file.path("data", "literature_turnover_rates.xlsx"))

lit_turnover <- lit_turnover %>% 
  # Arrange by turnover time
  arrange(u_d_mn) %>% 
  # Reassign n values
  mutate(n = seq(from = 1, to = nrow(lit_turnover)))

# Our summarized data
gen_calc_mini <- gen_calc_data_summarized %>% 
  # Calculate mean per terrain per inc time
  group_by(inc_time_d, terrain) %>% 
  summarize(u_d_mn = mean(u_d, na.rm = TRUE),
            u_d_max = max(u_d),
            u_d_min = min(u_d)) %>%
  # Calculate mean of means (combine inc_times)
  group_by(terrain) %>% 
  summarize(u_d_mn = mean(u_d_mn, na.rm = TRUE),
            u_d_max = max(u_d_mn, na.rm = TRUE),
            u_d_min = min(u_d_mn, na.rm = TRUE)) %>% 
  # Rename to match `lit_turnover` tibble
  rename(soil_type = terrain) %>% 
  arrange(u_d_mn) %>% 
  mutate(method = "2H Lipid SIP",
         n = c(17, 18, 19),
    soil_type = case_when(
      soil_type == "Niwot Ridge Tundra" ~ "tundra",
      soil_type == "Gordon Gulch Conifer Forest" ~ "conifer forest",
      soil_type == "Marshall Mesa Grassland" ~ "grassland")
  )

# Add in our data! ^_^
lit_turnover_w_ours <- lit_turnover %>% bind_rows(gen_calc_mini)

lit_turnover_w_ours <- lit_turnover_w_ours %>% 
  mutate(
    source = case_when(
      method == "2H Lipid SIP" ~ "This study",
      TRUE ~ "Literature values"
  ))


# By terrain  

lit_turnover_w_ours %>%
  # order by mean turnover rate
  ggplot(aes(x = n, 
             y = u_d_mn,
             color = soil_type)) +
  geom_segment(aes(y = 0, yend = u_d_mn, xend = n),
               color = "black") +
  geom_point(size = 3) +
  scale_color_npg() +
  geom_label(label = "This study",
            x = 18,
            y = 0.13,
            color = "black") +
  geom_label(label = "Literature values",
            x = 9,
            y = 0.6,
            color = "black") +
  #scale_y_log10() +
  #annotation_logticks(sides = "l") +
  coord_cartesian(
    xlim = c(0, 20),
    ylim = c(0, 0.80), 
    expand = FALSE) +
  labs(y = "Mean Turnover Time (d^-1)",
       color = "Soil Source") +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom")

## With log scale

lit_turnover_w_ours %>%
  # order by mean turnover rate
  ggplot(aes(x = n, 
             y = u_d_mn,
             color = soil_type)) +
  geom_segment(aes(y = 0, yend = u_d_mn, xend = n),
               color = "black") +
  geom_point(size = 3) +
  scale_color_npg() +
  geom_label(label = "This study",
            x = 18,
            y = 0.10,
            color = "black") +
  geom_label(label = "Literature values",
            x = 9,
            y = 0.35,
            color = "black") +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  labs(y = "Mean Turnover Time (d^-1)",
       color = "Soil Source") +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom")

```

## Literature Rates of Cell Turnover by Method
```{r}
lit_turnover_w_ours %>%
  # order by mean turnover rate
  ggplot(aes(x = n, 
             y = u_d_mn,
             color = method)) +
  geom_segment(aes(y = 0, yend = u_d_mn, xend = n),
               color = "black") +
  geom_point(size = 3) +
  geom_text_repel(aes(label = method),
                  color = "black",
                  size = 2,
                  segment.color = "red",
                  nudge_y = 0.2,
                  segment.curvature = -0.1,
                  segment.angle = -20,
                  segment.ncp = 3,
                  segment.size = 0.1) +
  scale_color_viridis_d() +
  scale_y_log10(breaks = c(0.01, 0.05, 0.1, 0.5)) +
  annotation_logticks(sides = "l") +
  labs(y = "Mean Turnover Time (d^-1)",
       color = "Soil Source") +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        )
```

