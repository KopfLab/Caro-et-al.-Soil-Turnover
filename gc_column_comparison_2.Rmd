---
title: "Column Comparison"
author: "Tristan Caro"
date: "2/16/2021"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
---

# Relevant Equations
## Plates (EP)

$$
N = 5.54\cdot(\frac{R_t}{W})^2
$$
Where N is the plate count (theoretical plates), Rt is retention time, W is peak width at 50% peak height (FWHM).

## Asymmetry (EP)
$$
A_s = \frac{w_{0.05}}{2d}
$$
Where $A_s$ is symmetry factor, $w_{0.05}$ is peak width at one-twentieth of peak height, d is distance between perpendicular dropped from the peak max and the leading edge of the peak at one-twentieth peak height.


## Resolution
Chromeleon uses the European Pharmacopeia (EP) resolution equation.

$$
R = \frac{1.18(Rt_2 - Rt_1)}{(W_2 + W_1)}
$$

Where R is resolution, $Rt$ is retention time, and W is the peak width at 50% peak height (FWHM).

# Libraries

```{r}
# Libraries
library(tidyverse)
library(plotly)
library(ggrepel)
library(ggsci)
library(ggsignif)

# Source
source(file.path("libs", "visualization.R"))
source(file.path("libs", "chromleon.R"))
source(file.path("libs", "chromeleon_peaks.R"))
```

# Load Data

```{r}
# Define path and sample names
root <- "column_testing/run_data"
path_names <- list.files(root)
path_names <- path_names %>% 
  str_subset("blank", negate = TRUE) %>% 
  str_subset("Blank", negate = TRUE) %>% 
  str_subset("GCMS-STD", negate = TRUE)
sample_names <- path_names %>% 
  str_replace("TSQ.....", "") %>% 
  str_replace(".xls", "")

# Create a tibble of integration data
# read_chromeleon_export is a sourced function. See above.
all_data <-
  tibble(
    sample = sample_names,
    file = path_names,
    data = map(file.path(root, file), read_chromeleon_export),
    injection_details = map(data, "injection_details"),
    integration_results = map(data, "integration_results")
  ) %>% select(-data)

# Create a tibble of peak analysis data
peak_data <-
  tibble(
    sample = sample_names,
    file = path_names,
    data = map(file.path(root, file), read_chromeleon_export_peaks),
    injection_details = map(data, "injection_details"),
    integration_results = map(data, "integration_results")
  ) %>% select(-data)
```

# Data cleanup

```{r, warning = FALSE}
# Data cleanup
results <- all_data %>%
  select(-injection_details) %>% 
  unnest(integration_results) %>% 
  filter(nchar(`Peak Name`) > 0) %>% 
  # major compound groups
  mutate(
    group = `Peak Name` %>% str_remove("\\d+-OH") %>% parse_number() %>% abs() %>% {paste0("C", .)} %>% factor(),
    saturation = case_when(
      str_detect(`Peak Name`, ":0") ~ "n0",
      str_detect(`Peak Name`, "PAIBE") ~ "n0",
      str_detect(`Peak Name`, ":1") ~ "n1",
      str_detect(`Peak Name`, ":2") ~ "n2",
      str_detect(`Peak Name`, ":3") ~ "n3",
      str_detect(`Peak Name`, ":4") ~ "n4",
      str_detect(`Peak Name`, ":5") ~ "n5",
      str_detect(`Peak Name`, ":6") ~ "n6",
      str_detect(`Peak Name`, ":7") ~ "n7",
    ),
    is_standard = case_when(
      str_detect(`Peak Name`, "STD") ~ TRUE,
      str_detect(`Peak Name`, "STD", negate = TRUE) ~ FALSE,
    ),
    column_type = case_when(
      str_detect(`sample`, "DB1") ~ "DB1",
      str_detect(`sample`, "DB5") ~ "DB5",
      str_detect(`sample`, "ZBFAMES") ~ "ZBFAMES",
    ),
    standard_ID = case_when(
      str_detect(`sample`, "BAME") ~ "BAME",
      str_detect(`sample`, "FAMES37") ~ "37FAME",
    )
  )


# Turn Column type into a factor
results$column_type <- factor(results$column_type, levels = c("DB1", "DB5", "ZBFAMES"))

```

# Overview Plot
```{r, fig.width=10, fig.height=6, warning=FALSE}
# Overview Plot
p_fames_db1 <- results %>%
  ggplot() +
    aes(x = `Retention Time`, y = `Relative Height`, fill = saturation, key = `Peak Name`, label = `Peak Name`) +
    geom_bar(stat = 'identity', width = 0.1) +
    facet_grid(rows = vars(column_type), cols = vars(standard_ID), scales = "free_y") +
    ggtitle("FAME Standards Overview") +
    theme_bw() +
    scale_fill_npg() +
    theme(legend.position = "bottom")
p_fames_db1
```


```{r}
peak_analysis <- peak_data %>%
  select(-injection_details) %>% 
  unnest(integration_results) %>% 
  filter(nchar(`Peak Name`) > 0) %>% 
  # major compound groups
  mutate(
    group = `Peak Name` %>% str_remove("\\d+-OH") %>% parse_number() %>% abs() %>% {paste0("C", .)} %>% factor(),
    saturation = case_when(
      str_detect(`Peak Name`, ":0") ~ "n0",
      str_detect(`Peak Name`, "PAIBE") ~ "n0",
      str_detect(`Peak Name`, ":1") ~ "n1",
      str_detect(`Peak Name`, ":2") ~ "n2",
      str_detect(`Peak Name`, ":3") ~ "n3",
      str_detect(`Peak Name`, ":4") ~ "n4",
      str_detect(`Peak Name`, ":5") ~ "n5",
      str_detect(`Peak Name`, ":6") ~ "n6",
      str_detect(`Peak Name`, ":7") ~ "n7",
    ),
    is_standard = case_when(
      str_detect(`Peak Name`, "STD") ~ TRUE,
      str_detect(`Peak Name`, "STD", negate = TRUE) ~ FALSE,
    ),
    column_type = case_when(
      str_detect(`sample`, "DB1") ~ "DB1",
      str_detect(`sample`, "DB5") ~ "DB5",
      str_detect(`sample`, "ZBFAMES") ~ "ZBFAMES",
    ),
    standard_ID = case_when(
      str_detect(`sample`, "BAME") ~ "BAME",
      str_detect(`sample`, "FAMES37") ~ "37FAME",
    )
  )


# Turn Column type into a factor
results$column_type <- factor(results$column_type, levels = c("DB1", "DB5", "ZBFAMES"))
```
# Resolution Plot
Significance testing via Wilcox Test

```{r}
p_resolution <- peak_analysis %>% ggplot(aes(x = column_type, y = `Resolution (EP)`, fill = column_type)) +
  geom_boxplot() +
  facet_wrap(~standard_ID)+
  scale_fill_npg() +
  geom_signif(comparisons = list(c("DB1", "DB5"), c("DB5", "ZBFAMES")),
              textsize = 2) +
  geom_signif(comparisons = list(c("DB1", "ZBFAMES")),
              y_position = 40,
              textsize = 2) +
  xlab("Column Type") +
  ggtitle("FAME Peak Resolution") +
  theme_classic() +
  theme(legend.title = element_blank())
p_resolution
```


# Symmetry Plot
Significance testing via Wilcox Test

```{r}
p_symmetry <- peak_analysis %>% ggplot(aes(x = column_type, y = `Asymmetry (EP)`, color = saturation)) +
  geom_point() +
  geom_jitter(width = 0.2, height = 0) +
  facet_wrap(~standard_ID)+
  scale_color_npg() +
  geom_signif(comparisons = list(c("DB1", "DB5"), c("DB5", "ZBFAMES")),
              textsize = 2,
              map_signif_level = TRUE,
              color = "black") +
  geom_signif(comparisons = list(c("DB1", "ZBFAMES")),
              y_position = 4.1,
              textsize = 2,
              map_signif_level = TRUE,
              color = "black") +
  xlab("Column Type") +
  ggtitle("FAME Peak Asymmetry") +
  theme_classic() +
  theme(legend.title = element_blank())
p_symmetry
```


# Plates Plot
Significance testing via Wilcox Test

```{r}
p_plates <- peak_analysis %>% ggplot(aes(x = column_type, y = `Plates (EP)`, color = saturation)) +
  geom_point() +
  geom_jitter(width = 0.2, height = 0) +
  facet_wrap(~standard_ID)+
  scale_color_npg() +
  geom_signif(comparisons = list(c("DB1", "DB5"), c("DB5", "ZBFAMES")),
              textsize = 2,
              map_signif_level = TRUE,
              color = "black") +
  geom_signif(comparisons = list(c("DB1", "ZBFAMES")),
              textsize = 2,
              map_signif_level = TRUE,
              y_position = 6e6,
              color = "black") +
  xlab("Column Type") +
  ggtitle("FAME Plates") +
  theme_classic() +
  theme(legend.title = element_blank())
p_plates
```

# Retention Time Plot

```{r}
p_retention <- peak_analysis %>% ggplot(aes(x = column_type, y = `Retention Time`, color = saturation)) +
  geom_point() +
  geom_jitter(width = 0.2, height = 0) +
  facet_wrap(~standard_ID)+
  scale_color_npg() +
  geom_signif(comparisons = list(c("DB1", "DB5"), c("DB5", "ZBFAMES")),
              textsize = 2,
              map_signif_level = TRUE,
              color = "black") +
  geom_signif(comparisons = list(c("DB1", "ZBFAMES")),
              textsize = 2,
              map_signif_level = TRUE,
              color = "black",
              y_position = 41) +
  xlab("Column Type") +
  ylab("Retention Time (Minutes") +
  ggtitle("FAME Retention Times") +
  theme_classic() +
  theme(legend.title = element_blank())
p_retention
```


