---
title: "Paper Figures"
author: "Tristan Caro"
date: "`r Sys.Date()`"
output:
    html_document:
    code_folding: show
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Libraries
```{r, echo = FALSE, warning = FALSE, message=FALSE}
library(tidyverse)    # CRAN v1.3.1 
library(forcats)      # CRAN v0.5.1 
library(isoreader)    # [::NA/NA] v1.3.0 # CRAN v1.3.0
library(isoprocessor) # [github::isoverse/isoprocessor] v0.6.7 
library(isotopia)     # [github::isoverse/isotopia] v0.5.8
library(readxl)       # CRAN v1.3.1
library(ggsci)        # CRAN v2.9 
'ggplot2' 
library(ggborderline) # [github::wurli/ggborderline] v0.1.0 
library(ggrepel)      # CRAN v0.9.1
'ggplot2' 
library(latex2exp)    # CRAN v0.5.0 
library(ggdist)       # CRAN v3.0.0 
library(ggsignif)     # CRAN v0.6.2
library(ggridges)     # CRAN v0.5.3
```


# Load Workspace Image

```{r}
load("cache/qSIP_calculations.RData")

load("cache/qSIP_taxonomy.RData")
```

# Set color swatches

```{r}
tundra_color <- "#445775"

grassland_color <- "#6e2114"

conifer_color <- "#5d6e5b"

terrain_color_swatch <- c(conifer_color, grassland_color, tundra_color)
terrain_fill_swatch <- c(conifer_color, "#912511", "#314669")
```


# Plots

## Figure: Microbial turnover rate across soil types

**Figure 1:** Microbial turnover rates (Âµ) across soil types, measured after 7 days of incubation. Each point represents turnover of a single identified fatty acid.

```{r turnover_across_soil}
p_turnover_distributions <- gen_calc_data %>% 
  filter(inc_time_d == 7,
         chain_num < 19) %>%
  mutate(terrain = case_when(
    terrain == "Gordon Gulch Conifer Forest" ~ "Conifer Forest",
    terrain == "Marshall Mesa Grassland" ~ "Grassland",
    terrain == "Niwot Ridge Tundra" ~ "Tunrda" )) %>% 
  mutate(terrain = forcats::fct_reorder(terrain, -u_d)) %>% 
  ggplot(
  aes(x = u_d, 
      y = terrain,
      color = terrain,
      fill = terrain)) +
  stat_slab(height = 0.5, 
            alpha = 0.7,
            color = "black") +
  stat_pointinterval(color = "black",
                     height = 0.2) +
  geom_point(
    color = "black",
    shape = 124,
    size = 5,
    alpha = 0.5,
    position = position_nudge(y = -.15)) +
  scale_x_log10() +
  annotation_logticks(sides = "b") +
  scale_fill_manual(values = terrain_fill_swatch) +
  scale_color_manual(values = terrain_color_swatch) +
  theme_classic() +
  labs(y = "Soil Type",
       x = TeX("Turnover rate ($d^{-1}$)")) +
  theme(axis.text.y = element_text(hjust = 1),
        legend.position = "none")
p_turnover_distributions
```

```{r mean_generation_time}
p_gen_time_mean <- gen_calc_data_summarized %>% 
  filter(inc_time_d == 7) %>% 
  mutate(terrain = case_when(
    terrain == "Gordon Gulch Conifer Forest" ~ "Conifer Forest",
    terrain == "Marshall Mesa Grassland" ~ "Grassland",
    terrain == "Niwot Ridge Tundra" ~ "Tunrda" )) %>% 
  group_by(terrain, inc_time_d) %>% 
  summarize(terrain = terrain,
            gen_d_weighted = gen_d_weighted) %>% 
  unique() %>% 
  ggplot(aes(x = terrain,
             y = gen_d_weighted,
             fill = terrain)) +
  geom_col(width = 0.5) +
  scale_fill_manual(values = terrain_fill_swatch) +
  labs(x = "Soil Type",
       y = "Community Generation Time (d)",
       caption = "Generation time weighted by compound relative abundance") +
  theme_classic() +
  theme(legend.position = "none")
p_gen_time_mean
```

```{r cowplot mooooo}
p_community_turnover_cow <- cowplot::plot_grid(
  p_turnover_distributions,
  p_gen_time_mean,
  labels = "AUTO",
  rel_widths = c(1,1),
  align = "h",
  nrow = 1
) 


save_plot(filename = "fig_output/p_community_turnover_cow.png",
          plot = p_community_turnover_cow,
          base_height = 5,
          base_width = 10
          )

```


## Figure: Compound-specific turnover rates

**Figure 2**: Compound-specific turnover rates after seven days of incubation as a mean across all soil types (A) and divided by soil type (B).

```{r compound_specific}
gen_calc_data_summarized %>% 
  # Remove zero timepoint
  filter(inc_time_d == 7) %>%
  group_by(compound) %>% 
  summarize_if(is.numeric, mean, na.rm = TRUE) %>% 
  mutate(compound = fct_reorder(compound, u_d)) %>% 
  ggplot(aes(x = compound,
             y = u_d,
             fill = u_d)) +
  geom_col(position = "dodge") +
  scale_fill_viridis_c(option = "plasma") +
  labs(x = "Compound",
       y = TeX("Mean turnover rate (d$^{-1}$)"),
       fill = TeX("Mean turnover rate (d$^{-1}$)")) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, 
                               hjust = 1),
    legend.key.width = unit(0.5, "line")
  )
```

```{r}
gen_calc_data_summarized %>% 
  # Remove zero time points and i-16:0
  # which doesn't show up in two soil types
  filter(inc_time_d == 7,
         compound != "i-16:0") %>% 
  group_by(terrain, compound) %>% 
  summarize_if(is.numeric, mean, na.rm = TRUE) %>% 
  mutate(compound = forcats::fct_reorder(compound, u_d)) %>% 
  ggplot(aes(x = compound,
             y = u_d,
             fill = u_d)) +
  geom_col(position = "dodge") +
  facet_wrap(vars(terrain)) +
  scale_fill_viridis_c(option = "plasma") +
  labs(x = "Compound",
       y = TeX("Mean turnover rate (d$^{-1}$)"),
       fill = TeX("Mean turnover rate (d$^{-1}$)"))+
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, 
                               hjust = 1),
    axis.title.x = element_blank(),
    legend.key.width = unit(3, "line"),
    legend.key.height = unit(0.5, "line"),
    legend.position = "top"
  )
```




```{r}
fatty_acids_wide_with_tax %>% 
  select(-ID) %>% 
  pivot_longer(cols = -phylum, 
               names_to = "FA",
               values_to = "rel_abund") %>%
  ggplot(aes(x = FA, 
             y = rel_abund,
             color = phylum,
             fill = phylum)) +
  stat_pointinterval(point_interval = "mean_qi") +
  facet_wrap(vars(phylum)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1),
        legend.position = "none")
```



## Figure: Weighted 2H incorporation over time

```{r weighted_incorp}
peaks_mapped_summarized %>% 
  mutate(compound = forcats::fct_reorder(compound, rt)) %>% 
  ggplot(aes(x = inc_time_d,
             y = at2H,
             group = compound)) +
  geom_borderline(color = "gray") +
  geom_point() +
  geom_line(aes(x = inc_time_d,
                y = at2H_weighted,
                color = terrain),
            size = .8) +
  geom_point(aes(x = inc_time_d,
                y = at2H_weighted, 
                color = terrain),
             shape = 18,
             size = 3) +
  geom_label_repel(data = peaks_mapped_summarized %>% filter(inc_time_d == 7),
                   nudge_x = 2,
                   nudge_y = 0.005,
                   size = 2.5,
                   aes(label = compound)) +
  geom_label_repel(data = weighted_time_course %>% filter(inc_time_d == 3),
                   aes(x = inc_time_d,
                       y = at2H_weighted,
                       group = terrain,
                       color = terrain),
                   label = "Weighted Mean",
                   nudge_y = -.01,
                   nudge_x = 1,
                   size = 2.5) +
  facet_wrap(vars(terrain), nrow = 1) +
  scale_x_continuous(breaks = c(0, 3, 7)) +
  scale_color_manual(values = terrain_color_swatch) +
  coord_cartesian(xlim = c(0, 10), clip = FALSE) +
  labs(x = "Incubation Time (Days)",
       y = TeX("% $^2H$"),
       color = "Soil Type") +
  theme_classic() +
  theme(legend.position = "none",
        strip.background = element_blank())
```


## Figure: Weighted turnover time


```{r 2H_plots}
peaks_mapped_summarized_wppm <- peaks_mapped_summarized %>% 
    mutate(at2H_ppm = at2H * 10000,
         at2H_mn_zero_ppm = at2H_mn_zero * 10000,
         at2H_weighted_ppm = at2H_weighted * 10000)



p_conifer_2H <- peaks_mapped_summarized_wppm %>% 
  filter(terrain == "Gordon Gulch Conifer Forest") %>% 
  ggplot(aes(x = inc_time_d,
             y = at2H_ppm,
             group = compound)) +
  geom_borderline(color = "gray") +
  geom_point(alpha = 0.5,
             size = 3) +
  geom_borderline(aes(x = inc_time_d,
                y = at2H_weighted_ppm,
                color = terrain),
            size = .8) +
  geom_point(aes(x = inc_time_d,
                y = at2H_weighted_ppm, 
                color = terrain),
             size = 3,
             alpha = 0.5) +
  # geom_label_repel(data = peaks_mapped_summarized_wppm %>%
  #                    filter(inc_time_d == 7,
  #                           terrain == "Gordon Gulch Conifer Forest"),
  #                  aes(label = compound),
  #                  size = 2.5,
  #                  nudge_x = 2) +
  # geom_label_repel(data = weighted_time_course %>%
  #                    filter(inc_time_d == 7,
  #                           terrain == "Gordon Gulch Conifer Forest"),
  #                  aes(x = inc_time_d,
  #                      y = at2H_weighted*10000,
  #                      group = terrain,
  #                      color = terrain),
  #                  label = "Weighted Mean",
  #                  size = 2.5,
  #                  nudge_x = 1,
  #                  nudge_y = 10) +
  scale_x_continuous(breaks = c(0, 1,2,3,4,5,6,7)) +
  scale_color_manual(values = conifer_color) +
  coord_cartesian(xlim = c(0, 8), ylim = c(0, 1300), clip = "off") +
  labs(x = "Incubation Time (Days)",
       y = TeX("$^2H$ (ppm)"),
       title = "Conifer Forest") +
  theme_classic() +
  theme(legend.position = "none",
        strip.background = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(size = 10))
p_conifer_2H

p_grassland_2H <- peaks_mapped_summarized_wppm %>% 
  filter(terrain == "Marshall Mesa Grassland") %>% 
  mutate(compound = forcats::fct_reorder(compound, rt)) %>% 
  ggplot(aes(x = inc_time_d,
             y = at2H_ppm,
             group = compound)) +
  geom_borderline(color = "gray") +
  geom_point(alpha = 0.5,
             size = 3) +
  geom_borderline(aes(x = inc_time_d,
                y = at2H_weighted_ppm,
                color = terrain),
            size = .8) +
  geom_point(aes(x = inc_time_d,
                y = at2H_weighted_ppm, 
                color = terrain),
             size = 3,
             alpha = 0.5) +
  # geom_label_repel(data = peaks_mapped_summarized_wppm %>%
  #                    filter(inc_time_d == 7,
  #                           terrain == "Marshall Mesa Grassland"),
  #                  aes(label = compound),
  #                  size = 2.5,
  #                  nudge_x = 2) +
  # geom_label_repel(data = weighted_time_course %>%
  #                    filter(inc_time_d == 7,
  #                           terrain == "Marshall Mesa Grassland"),
  #                  aes(x = inc_time_d,
  #                      y = at2H_weighted*10000,
  #                      group = terrain,
  #                      color = terrain),
  #                  label = "Weighted Mean",
  #                  size = 2.5,
  #                  nudge_x = 1,
  #                  nudge_y = -75) +
  scale_x_continuous(breaks = c(0, 1,2,3,4,5,6,7)) +
  scale_color_manual(values = grassland_color) +
  coord_cartesian(xlim = c(0, 8), ylim = c(0, 1300), clip = "off") +
  labs(x = "Incubation Time (Days)",
       y = TeX("$^2H$ (ppm)"),
       title = "Grassland") +
  theme_classic() +
  theme(legend.position = "none",
        strip.background = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(size = 10))
p_grassland_2H

p_tundra_2H <- peaks_mapped_summarized_wppm %>% 
  filter(terrain == "Niwot Ridge Tundra") %>% 
  mutate(compound = forcats::fct_reorder(compound, rt)) %>% 
  ggplot(aes(x = inc_time_d,
             y = at2H_ppm,
             group = compound)) +
  geom_borderline(color = "gray") +
  geom_point(alpha = 0.5,
             size = 3) +
  geom_borderline(aes(x = inc_time_d,
                y = at2H_weighted_ppm,
                color = terrain),
            size = .8) +
  geom_point(aes(x = inc_time_d,
                y = at2H_weighted_ppm, 
                color = terrain),
             size = 3,
             alpha = 0.5) +
  # geom_label_repel(data = peaks_mapped_summarized_wppm %>%
  #                    filter(inc_time_d == 7,
  #                           terrain == "Niwot Ridge Tundra"),
  #                  aes(label = compound),
  #                  size = 2.5,
  #                  nudge_x = 2) +
  # geom_label_repel(data = weighted_time_course %>%
  #                    filter(inc_time_d == 7,
  #                           terrain == "Niwot Ridge Tundra"),
  #                  aes(x = inc_time_d,
  #                      y = at2H_weighted*10000,
  #                      group = terrain,
  #                      color = terrain),
  #                  label = "Weighted Mean",
  #                  size = 2.5,
  #                  nudge_x = 1,
  #                  nudge_y = 50) +
  scale_x_continuous(breaks = c(0, 1,2,3,4,5,6,7)) +
  scale_color_manual(values = tundra_color) +
  coord_cartesian(xlim = c(0, 8), ylim = c(0, 1300), clip = "off") +
  labs(x = "Incubation Time (Days)",
       y = TeX("$^2H$ (ppm)"),
       title = "Tundra") +
  theme_classic() +
  theme(legend.position = "none",
        strip.background = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(size = 10))
p_tundra_2H
```

```{r turnover_plots}
add_weighted_mean <- function(df) {
  df %>% 
    ungroup() %>% 
    mutate(type = "sample") %>% 
    add_row(compound = "Weighted Mean",
            u_d_weighted = df$u_d_weighted[1],
            terrain = df$terrain[1],
            u_d = df$u_d_weighted[1],
            type = "Weighted Mean")
}



p_conifer_u_d <- gen_calc_data_summarized %>%
  filter(terrain == "Gordon Gulch Conifer Forest",
         inc_time_d == 7) %>% 
  select(terrain, inc_time_d, compound, u_d, u_d_weighted) %>%
  add_weighted_mean() %>% 
  mutate(compound = forcats::fct_reorder(compound, u_d)) %>%
  # PLOT IT
  ggplot() +
  geom_col(aes(x = compound,
               y = u_d, 
               fill = type)) +
  scale_fill_manual(values = c("#000000", conifer_color)) +
  coord_flip(ylim = c(0, 0.09), clip = "off") +
  labs(y = TeX("Turnover ($d^{-1}$)"),
       title = "Conifer Forest") +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5))
p_conifer_u_d


p_grassland_u_d <- gen_calc_data_summarized %>% 
  filter(terrain == "Marshall Mesa Grassland",
         inc_time_d == 7) %>% 
  select(terrain, inc_time_d, compound, u_d, u_d_weighted) %>% 
  add_weighted_mean() %>% 
  mutate(compound = forcats::fct_reorder(compound, u_d)) %>%
  # PLOT IT
  ggplot() +
  geom_col(aes(x = compound, y = u_d, fill = type)) +
  scale_fill_manual(values = c("#000000", grassland_color)) +
  coord_flip(ylim = c(0, 0.09), clip = "off") +
  labs(y = TeX("Turnover ($d^{-1}$)"),
       title = "Grassland") +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5))

p_tundra_u_d <- gen_calc_data_summarized %>% 
  filter(terrain == "Niwot Ridge Tundra",
         inc_time_d == 7) %>% 
  select(terrain, inc_time_d, compound, u_d, u_d_weighted) %>% 
  add_weighted_mean() %>% 
  mutate(compound = forcats::fct_reorder(compound, u_d)) %>%
  # PLOT IT
  ggplot() +
  geom_col(aes(x = compound, y = u_d, fill = type)) +
  scale_fill_manual(values = c("#000000", tundra_color)) +
  coord_flip(ylim = c(0, 0.09), clip = "off") +
  labs(y = TeX("Turnover ($d^{-1}$)"),
       title = "Tundra") +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5))
p_tundra_u_d
```

```{r moo}
p_turnover_enrichment_cow <- cowplot::plot_grid(
  p_conifer_2H,
  p_grassland_2H,
  p_tundra_2H,
  p_conifer_u_d,
  p_grassland_u_d,
  p_tundra_u_d,
  labels = "AUTO",
  rel_widths = c(1,1),
  align = "h",
  nrow = 2
) 

p_turnover_enrichment_cow

save_plot(filename = "fig_output/p_turnover_enrichment_cow.png",
          plot = p_turnover_enrichment_cow,
          base_height = 8,
          base_width = 12
          )
```





# Supplementary Figures

## Meta analysis of turnover rates reported in literature

```{r}
lit_turnover_w_ours %>%
  # order by mean turnover rate
  ggplot(aes(x = n, 
             y = u_d_mn,
             color = soil_type)) +
  geom_segment(aes(y = 0, yend = u_d_mn, xend = n),
               color = "black") +
  geom_point(size = 3) +
  scale_color_npg() +
  geom_label(aes(
    x = 9,
    y = 0.4),
            label = "Literature values",
            color = "black") +
  geom_label(aes(
    x = 18,
    y = .1),
             label = "This study",
             color = "black") +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  labs(y = TeX("Mean turnover rate ($d^{-1}$)"),
       color = "Soil Source") +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom")
```

## Meta analysis of turnover rates in literature, grouped by method

```{r}
p_lit_turnover_across_method <- lit_turnover_w_ours %>%
  # order by mean turnover rate
  ggplot(aes(x = n, 
             y = u_d_mn,
             color = source)) +
  geom_segment(aes(y = 0, yend = u_d_mn, xend = n),
               color = "black") +
  geom_point(size = 3) +
  geom_text_repel(aes(label = method),
                  color = "black",
                  size = 3.5,
                  segment.color = "red",
                  nudge_y = 0.2,
                  segment.curvature = -0.1,
                  segment.angle = -20,
                  segment.ncp = 3,
                  segment.size = 0.1) +
  scale_color_manual(values = c("#000000", "#1986bd")) +
  scale_y_log10(breaks = c(0.01, 0.05, 0.1, 0.5)) +
  annotation_logticks(sides = "l") +
  labs(y = TeX("Mean turnover rate ($d^{-1}$)"),
       color = "Soil Source") +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom"
        )

save_plot(filename = "fig_output/p_lit_turnover_across_method.png",
          plot = p_lit_turnover_across_method,
          base_height = 6,
          base_width = 8)
```

