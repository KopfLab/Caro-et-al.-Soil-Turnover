---
title: "Paper Figures"
author: "Tristan Caro"
date: "`r Sys.Date()`"
output:
    html_document:
    code_folding: show
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Libraries
```{r, echo = FALSE, warning = FALSE, message=FALSE}
library(tidyverse)    # CRAN v1.3.1 
library(forcats)      # CRAN v0.5.1 
library(isoreader)    # [::NA/NA] v1.3.0 # CRAN v1.3.0
library(isoprocessor) # [github::isoverse/isoprocessor] v0.6.7 
library(isotopia)     # [github::isoverse/isotopia] v0.5.8
library(readxl)       # CRAN v1.3.1
library(ggsci)        # CRAN v2.9 
'ggplot2' 
library(ggborderline) # [github::wurli/ggborderline] v0.1.0 
library(ggrepel)      # CRAN v0.9.1
'ggplot2' 
library(latex2exp)    # CRAN v0.5.0 
library(ggdist)       # CRAN v3.0.0 
library(ggsignif)     # CRAN v0.6.2
library(ggridges)     # CRAN v0.5.3
```


# Load Workspace Image

```{r}
load("cache/qSIP_calculations.RData")

load("cache/qSIP_taxonomy.RData")
```


# Plots

## Figure 1: Microbial turnover rate across soil types

**Figure 1:** Microbial turnover rates (Âµ) across soil types, measured after 7 days of incubation. Each point represents turnover of a single identified fatty acid.

```{r}
gen_calc_data %>% 
  filter(inc_time_d == 7,
         chain_num < 19) %>%
  ggplot(
  aes(y = u_d, 
      x = terrain,
      color = terrain,
      fill = terrain)) +
  stat_slab(width = 0.3, 
            alpha = 0.7,
            color = "black") +
  stat_pointinterval(color = "black") +
  geom_point(
    color = "black",
    shape = 95,
    size = 5,
    alpha = 0.5,
    position = position_nudge(x = -.07)) +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  scale_fill_npg() +
  scale_color_npg() +
  theme_classic() +
  labs(x = "Soil Type",
       y = TeX("Turnover rate ($d^{-1}$)")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Figure 2: Compound-specific turnover rates

**Figure 2**: Compound-specific turnover rates after seven days of incubation as a mean across all soil types (A) and divided by soil type (B).

```{r}
gen_calc_data_summarized %>% 
  # Remove zero timepoint
  filter(inc_time_d == 7) %>%
  group_by(compound) %>% 
  summarize_if(is.numeric, mean, na.rm = TRUE) %>% 
  mutate(compound = fct_reorder(compound, u_d)) %>% 
  ggplot(aes(x = compound,
             y = u_d,
             fill = u_d)) +
  geom_col(position = "dodge") +
  scale_fill_viridis_c(option = "plasma") +
  labs(x = "Compound",
       y = TeX("Mean turnover rate (d$^{-1}$)"),
       fill = TeX("Mean turnover rate (d$^{-1}$)")) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, 
                               hjust = 1),
    legend.key.width = unit(0.5, "line")
  )
```

```{r}
gen_calc_data_summarized %>% 
  # Remove zero time points and i-16:0
  # which doesn't show up in two soil types
  filter(inc_time_d == 7,
         compound != "i-16:0") %>% 
  group_by(terrain, compound) %>% 
  summarize_if(is.numeric, mean, na.rm = TRUE) %>% 
  mutate(compound = forcats::fct_reorder(compound, u_d)) %>% 
  ggplot(aes(x = compound,
             y = u_d,
             fill = u_d)) +
  geom_col(position = "dodge") +
  facet_wrap(vars(terrain)) +
  scale_fill_viridis_c(option = "plasma") +
  labs(x = "Compound",
       y = TeX("Mean turnover rate (d$^{-1}$)"),
       fill = TeX("Mean turnover rate (d$^{-1}$)"))+
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, 
                               hjust = 1),
    axis.title.x = element_blank(),
    legend.key.width = unit(3, "line"),
    legend.key.height = unit(0.5, "line"),
    legend.position = "top"
  )
```




```{r}
fatty_acids_wide_with_tax %>% 
  select(-ID) %>% 
  pivot_longer(cols = -phylum, 
               names_to = "FA",
               values_to = "rel_abund") %>%
  ggplot(aes(x = FA, 
             y = rel_abund,
             color = phylum,
             fill = phylum)) +
  stat_pointinterval(point_interval = "mean_qi") +
  facet_wrap(vars(phylum)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1),
        legend.position = "none")
```














# Supplementary Figures

## Meta analysis of turnover rates reported in literature

```{r}
lit_turnover_w_ours %>%
  # order by mean turnover rate
  ggplot(aes(x = n, 
             y = u_d_mn,
             color = soil_type)) +
  geom_segment(aes(y = 0, yend = u_d_mn, xend = n),
               color = "black") +
  geom_point(size = 3) +
  scale_color_npg() +
  geom_label(aes(
    x = 9,
    y = 0.4),
            label = "Literature values",
            color = "black") +
  geom_label(aes(
    x = 18,
    y = .1),
             label = "This study",
             color = "black") +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  labs(y = TeX("Mean turnover rate ($d^{-1}$)"),
       color = "Soil Source") +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom")
```

## Meta analysis of turnover rates in literature, grouped by method

```{r}
lit_turnover_w_ours %>%
  # order by mean turnover rate
  ggplot(aes(x = n, 
             y = u_d_mn,
             color = method)) +
  geom_segment(aes(y = 0, yend = u_d_mn, xend = n),
               color = "black") +
  geom_point(size = 3) +
  geom_text_repel(aes(label = method),
                  color = "black",
                  size = 3.5,
                  segment.color = "red",
                  nudge_y = 0.2,
                  segment.curvature = -0.1,
                  segment.angle = -20,
                  segment.ncp = 3,
                  segment.size = 0.1) +
  scale_color_viridis_d() +
  scale_y_log10(breaks = c(0.01, 0.05, 0.1, 0.5)) +
  annotation_logticks(sides = "l") +
  labs(y = TeX("Mean turnover rate ($d^{-1}$)"),
       color = "Soil Source") +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom"
        )
```

